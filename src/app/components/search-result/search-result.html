<div
  *ngIf="isOpen"
  class="absolute top-full left-0 right-0 mt-1 bg-card-bg border border-border rounded-lg shadow-xl z-50 max-h-[500px] overflow-y-auto"
  (clickOutside)="closeResults()"
>
  <div *ngIf="!currentLocation" class="p-8 text-center">
    <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </div>
    <h3 class="text-text text-sm font-bold mb-1">Sin ubicación seleccionada</h3>
    <p class="text-text-light text-xs mb-4">Para buscar servicios, primero necesitamos saber dónde te encuentras.</p>
    <button
      (click)="openAddressModalManual()"
      class="inline-flex items-center px-4 py-2 bg-primary text-white text-xs font-bold rounded-md hover:bg-primary-dark transition-colors"
    >
      Seleccionar ubicación
    </button>
  </div>

  <div *ngIf="currentLocation && isLoading" class="p-4 text-center">
    <div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-primary border-t-transparent"></div>
    <p class="mt-1 text-xs text-text-light">Buscando en {{ currentLocation.city }}...</p>
  </div>

  <div *ngIf="currentLocation && !isLoading && searchResults">

    <div *ngIf="searchResults.totalResults === 0" class="p-6 text-center">
      <p class="text-sm font-semibold text-text mb-0.5">Sin resultados en {{ currentLocation.city }}</p>
      <p class="text-xs text-text-light">Intenta con otros términos dentro de {{ currentLocation.state }}.</p>
    </div>

    <div *ngIf="searchResults.totalResults > 0">

      <div class="px-3 py-1.5 bg-card-bg-light border-b border-border flex justify-between items-center">
        <span class="text-[9px] uppercase font-bold text-text-light tracking-widest">
          Resultados en <span class="text-primary">{{ currentLocation.city }}</span>
        </span>
      </div>

      <div *ngIf="searchResults.categories.total > 0" class="border-b border-border">
        <div class="px-3 py-2 bg-card-bg-light/30">
          <h3 class="text-[10px] font-black uppercase text-text/60 tracking-widest">Categorías</h3>
        </div>
        <div class="py-1">
          <button
            *ngFor="let category of searchResults.categories.results.slice(0, 4)"
            (click)="onCategoryClick(category)"
            class="w-full px-3 py-2 hover:bg-primary/5 transition-colors text-left group flex items-center gap-3"
          >
            <div class="w-8 h-8 rounded bg-primary/10 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-all">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
              </svg>
            </div>
            <div class="flex-1 truncate">
              <p class="text-sm font-bold text-text group-hover:text-primary truncate">{{ category.name }}</p>
              <p class="text-[10px] text-text-light">{{ category.professionalsCount }} profesionales activos</p>
            </div>
          </button>
        </div>
      </div>

      <div *ngIf="searchResults.providers.total > 0">
        <div class="px-3 py-2 bg-card-bg-light/30 border-b border-border/50">
          <h3 class="text-[10px] font-black uppercase text-text/60 tracking-widest">Profesionales y Empresas</h3>
        </div>

        <div class="py-1">
          <button
            *ngFor="let provider of searchResults.providers.results.slice(0, 10)"
            (click)="onProviderClick(provider)"
            class="w-full px-3 py-2 text-left group relative border-l-4 transition-all"
            [ngClass]="provider.isPromocional
                ? 'bg-yellow-500/5 border-yellow-500'
                : 'hover:bg-card-bg-light border-transparent'"
          >
            <div *ngIf="provider.isPromocional" class="absolute top-0 right-0">
               <span class="bg-yellow-500 text-black text-[8px] font-black px-2 py-0.5 rounded-bl-md uppercase tracking-tighter">
                 {{ provider.type === 'professional' ? 'Profesional Promocionado' : 'Empresa Promocionada' }}
               </span>
            </div>

            <div class="flex items-center gap-3">
              <div class="relative">
                <div *ngIf="provider.photoUrl"
                     class="w-10 h-10 rounded-full bg-cover bg-center border"
                     [ngClass]="provider.isPromocional ? 'border-yellow-500 shadow-sm' : 'border-border'"
                     [style.background-image]="'url(' + provider.photoUrl + ')'">
                </div>
                <div *ngIf="!provider.photoUrl"
                     class="w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold"
                     [ngClass]="provider.isPromocional ? 'bg-yellow-500 text-black' : 'bg-primary text-white'">
                  {{ getProviderInitials(provider) }}
                </div>
                <div *ngIf="provider.hasActiveSubscription"
                     class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-success border-2 border-card-bg rounded-full shadow-sm">
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-1">
                  <p class="text-sm font-bold truncate text-text group-hover:text-primary transition-colors">
                    {{ provider.fullName }}
                  </p>
                  <svg *ngIf="provider.isVerified" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-success" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-[10px] text-text-light flex items-center gap-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    </svg>
                    {{ provider.location?.city }}
                  </span>
                  <span *ngIf="provider.distanceInMeters" class="text-[10px] font-bold text-primary">
                    • a {{ (provider.distanceInMeters / 1000) | number:'1.1-2' }} km
                  </span>
                </div>
              </div>
            </div>
          </button>
        </div>
      </div>

    </div>
  </div>
</div>
