<div class="min-h-screen bg-gradient-to-br from-background via-background to-primary/5 py-4 px-4">
  <div class="max-w-5xl mx-auto space-y-4">

    <div class="text-center space-y-2">
      <div class="inline-block mb-1">
         <img src="/assets/img/logo/logo.png" alt="Logo TEBUSCO" class="mx-auto max-w-[100px] max-h-16 object-contain">
      </div>
      <h1 class="text-2xl font-bold text-text">
          Selecciona tus Áreas de Trabajo
      </h1>
      <p class="text-text-light text-sm max-w-2xl mx-auto">
        Elige las áreas profesionales donde ofrecerás tus servicios.
      </p>
    </div>

    <div class="bg-gradient-to-r from-primary/10 via-primary/5 to-primary/10 border border-primary/30 rounded-xl p-3 shadow-sm">
      <div class="flex items-center gap-3">
        <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-primary" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="flex-1">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-1">
             <p class="text-text font-semibold text-sm">
                 Límite: <span class="text-primary">{{ categoryLimit }}</span> área(s).
                 <span class="text-text-light font-normal text-xs ml-1">Especialidades ilimitadas.</span>
             </p>
             <div *ngIf="selectedLevel2Count > 0" class="flex items-center gap-2 min-w-[120px]">
                <div class="flex-1 bg-background rounded-full h-2 overflow-hidden border border-primary/10">
                  <div class="h-full bg-primary transition-all duration-500" [style.width.%]="(selectedLevel2Count / categoryLimit) * 100"></div>
                </div>
                <span class="text-xs font-bold text-primary">{{ selectedLevel2Count }}/{{ categoryLimit }}</span>
             </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="errorMessage" class="bg-danger/10 border border-danger/30 rounded-lg p-2 flex items-center gap-2 animate-fade-in">
      <svg class="w-5 h-5 text-danger" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
      <p class="text-danger text-xs font-medium">{{ errorMessage }}</p>
    </div>

    <div *ngIf="isLoading" class="flex justify-center items-center py-10">
      <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-primary"></div>
    </div>

    <div *ngIf="!isLoading" class="space-y-4">

      <div class="flex flex-col md:flex-row gap-3">
        <div class="flex-1 bg-surface rounded-lg shadow-sm p-2 border border-border overflow-x-auto flex items-center gap-2">
          <button *ngIf="currentPath.length > 0" (click)="goBack()" class="flex-shrink-0 px-2 py-1 bg-primary/10 hover:bg-primary text-primary hover:text-white rounded text-xs font-semibold transition-all">
             ← Volver
          </button>

          <div class="flex items-center gap-1 text-xs whitespace-nowrap">
             <span class="px-2 py-1 bg-background rounded border border-border font-medium">Inicio</span>
             <span *ngFor="let item of currentPath" class="flex items-center gap-1 text-text-light">
               <span>/</span>
               <span class="px-2 py-1 rounded border border-primary text-primary bg-primary/5 font-medium flex items-center gap-1">
                 <span [ngClass]="getLevelBadgeColor(item.level)" class="px-1 rounded text-[9px] font-bold border">{{ getLevelLabel(item.level) }}</span>
                 {{ item.name }}
               </span>
             </span>
          </div>
        </div>

        <div class="bg-surface rounded-lg shadow-sm p-2 border border-border flex items-center justify-between gap-3 min-w-[200px]">
           <span [ngClass]="getLevelBadgeColor(currentLevelType)" class="px-2 py-1 rounded text-xs font-bold border shadow-sm">
             Nivel {{ currentLevelType }}
           </span>
           <span class="text-xs text-text-light">{{ filteredCategories.length }} ítems</span>
        </div>
      </div>

      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="w-4 h-4 text-text-light" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
        </div>
        <input type="text" [(ngModel)]="searchTerm" (input)="filterCategories()"
          placeholder="Buscar categorías..."
          class="w-full pl-9 pr-8 py-2 text-sm border border-border bg-surface text-text rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all shadow-sm">
        <button *ngIf="searchTerm" (click)="searchTerm = ''; filterCategories()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-text-light hover:text-danger">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        <div *ngFor="let category of filteredCategories"
             (click)="selectCategory(category)"
             class="relative bg-surface rounded-xl shadow-sm border transition-all hover:shadow-md cursor-pointer overflow-hidden group p-3"
             [class.border-success]="category.level === 2 && isLevel2Selected(category.id)"
             [class.bg-success/5]="category.level === 2 && isLevel2Selected(category.id)"
             [class.ring-1]="category.level === 2 && isLevel2Selected(category.id)"
             [class.ring-success/30]="category.level === 2 && isLevel2Selected(category.id)"
             [class.border-primary]="category.level === 3 && isLevel3Selected(category.id)"
             [class.bg-primary/5]="category.level === 3 && isLevel3Selected(category.id)"
             [class.border-border]="!isLevel2Selected(category.id) && !isLevel3Selected(category.id)"
             [class.opacity-60]="category.level === 2 && !isLevel2Selected(category.id) && !canAddMoreLevel2"
             [class.cursor-not-allowed]="category.level === 2 && !isLevel2Selected(category.id) && !canAddMoreLevel2">

          <div *ngIf="(category.level === 2 && isLevel2Selected(category.id)) || (category.level === 3 && isLevel3Selected(category.id))"
               class="absolute top-2 right-2 z-10">
            <div [ngClass]="category.level === 2 ? 'bg-success' : 'bg-primary'" class="w-5 h-5 rounded-full flex items-center justify-center shadow-sm text-white">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            </div>
          </div>

          <div *ngIf="category.level === 2 && !isLevel2Selected(category.id) && !canAddMoreLevel2"
               class="absolute inset-0 bg-background/80 flex items-center justify-center z-10 backdrop-blur-[1px]">
             <span class="text-[10px] font-bold text-danger border border-danger/30 bg-danger/5 px-2 py-1 rounded">Límite alcanzado</span>
          </div>

          <div class="flex items-start gap-3 relative z-0">
             <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-primary/10 to-primary/5 flex items-center justify-center text-lg border border-primary/10 group-hover:scale-105 transition-transform">
               {{ getCategoryIcon(category) }}
             </div>

             <div class="flex-1 min-w-0">
               <div class="flex items-center gap-1 mb-0.5">
                 <h3 class="font-bold text-text text-sm group-hover:text-primary transition-colors truncate">
                   {{ category.name }}
                 </h3>
               </div>

               <p class="text-xs text-text-light leading-tight line-clamp-2" *ngIf="category.description">
                 {{ category.description }}
               </p>

               <div *ngIf="category.level === 2 && isLevel2Selected(category.id)" class="mt-2 pt-2 border-t border-success/20 flex items-center justify-between text-xs">
                 <span class="text-success font-bold flex items-center gap-1">
                   {{ getLevel3CountForLevel2(category.id) }} esp.
                 </span>
                 <span class="text-primary hover:underline cursor-pointer font-medium">
                   {{ getLevel3CountForLevel2(category.id) > 0 ? 'Editar' : 'Agregar' }}
                 </span>
               </div>

               <div *ngIf="hasChildren(category) && (category.level === 1 || (category.level === 2 && !isLevel2Selected(category.id)))" class="mt-2 text-[10px] text-text-light flex items-center gap-1">
                 <span class="w-1.5 h-1.5 rounded-full bg-primary/50"></span>
                 {{ category.children!.length }} {{ category.level === 1 ? 'áreas' : 'especialidades' }}
               </div>
             </div>
          </div>
        </div>
      </div>

      <div *ngIf="filteredCategories.length === 0" class="bg-surface rounded-lg shadow-sm p-8 text-center border border-border">
        <p class="text-text font-bold text-sm mb-1">No se encontraron resultados</p>
        <button (click)="searchTerm = ''; filterCategories()" class="text-xs text-primary hover:underline font-semibold">
          Limpiar búsqueda
        </button>
      </div>
    </div>

    <div *ngIf="selectedLevel2Count > 0" class="bg-success/5 border border-success/20 rounded-xl p-3 shadow-sm">
      <h3 class="font-bold text-text text-sm mb-3 flex items-center gap-2">
         <span class="w-2 h-2 rounded-full bg-success"></span>
         Resumen de Selección ({{ selectedLevel2Count }})
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div *ngFor="let selected of getSelectedLevel2Array()" class="bg-surface border border-success/20 rounded-lg p-2 flex flex-col gap-2">
           <div class="flex items-center justify-between">
              <div class="flex items-center gap-2 overflow-hidden">
                <span class="text-lg">{{ getCategoryIcon(selected.category) }}</span>
                <span class="font-bold text-xs text-text truncate">{{ selected.category.name }}</span>
              </div>
              <button (click)="removeLevel2Category(selected.category.id, $event)" class="text-danger hover:bg-danger/10 p-1 rounded transition-colors" title="Eliminar">
                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
              </button>
           </div>

           <div class="flex flex-wrap gap-1">
             <span *ngIf="selected.selectedLevel3Ids.length === 0" class="text-[10px] text-text-light italic">Sin especialidades</span>
             <span *ngFor="let level3Id of selected.selectedLevel3Ids" class="bg-primary/5 border border-primary/10 text-primary px-1.5 py-0.5 rounded text-[10px]">
               {{ getCategoryNameById(level3Id, selected.category.children) }}
             </span>
           </div>
        </div>
      </div>
    </div>

    <div class="bg-primary/5 border border-primary/20 rounded-lg p-3 flex items-start gap-3">
       <div class="flex-shrink-0 w-5 h-5 bg-primary/20 text-primary rounded flex items-center justify-center text-xs font-bold">i</div>
       <div class="text-xs text-text-light space-y-1">
         <p>1. Navega por las categorías principales.</p>
         <p>2. Selecciona hasta <strong>{{ categoryLimit }}</strong> áreas.</p>
         <p>3. Marca tus especialidades.</p>
       </div>
    </div>

    <div class="flex items-center justify-between gap-3 pt-2 border-t border-border">
      <button (click)="onSkip()" [disabled]="isSaving" class="text-xs font-semibold text-text-light hover:text-text px-3 py-2 border border-transparent hover:border-border rounded transition-all">
        Configurar luego
      </button>

      <div class="flex gap-2">
        <button (click)="onBack()" [disabled]="isSaving" class="px-4 py-2 border border-border rounded-lg text-xs font-bold text-text hover:bg-surface-hover transition-all">
          Volver
        </button>

        <button (click)="onSave()" [disabled]="selectedLevel2Count === 0 || isSaving"
          class="px-5 py-2 bg-primary text-white rounded-lg font-bold text-xs flex items-center gap-2 shadow-sm hover:bg-primary-dark transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <span *ngIf="isSaving" class="animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"></span>
          {{ selectedLevel2Count === 0 ? 'Selecciona 1 área' : 'Guardar y Finalizar' }}
        </button>
      </div>
    </div>

  </div>
</div>
