<div class="min-h-screen bg-gradient-to-br from-background via-background to-primary/5 py-12 px-4 sm:px-6 lg:px-8">

  <!-- Loading State -->
  <div *ngIf="isLoading" class="max-w-5xl mx-auto flex justify-center items-center h-[60vh]">
    <div class="flex flex-col items-center">
      <div class="w-16 h-16 border-4 border-primary/20 border-t-primary rounded-full animate-spin mb-4"></div>
      <p class="text-text-light font-medium animate-pulse">Cargando detalles de la compra...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && error" class="max-w-2xl mx-auto mt-10">
    <div class="bg-surface border border-danger/20 rounded-2xl p-8 text-center shadow-lg">
      <div class="w-16 h-16 bg-danger/10 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-danger" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <h3 class="text-xl font-bold text-text mb-2">Ocurri√≥ un error</h3>
      <p class="text-text-light mb-6">{{ error }}</p>
      <button (click)="cancel()" class="px-6 py-2 bg-surface border border-border rounded-lg hover:bg-background transition-colors">
        Volver a Extras
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !error && package as pkg" class="max-w-6xl mx-auto animate-fade-in-up">

    <!-- Header -->
    <button (click)="cancel()" class="mb-6 flex items-center text-text-light hover:text-primary transition-colors group">
      <svg class="w-5 h-5 mr-2 transform group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Cancelar y volver
    </button>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

      <!-- LEFT COLUMN: Config & Payment -->
      <div class="lg:col-span-7 space-y-6">

        <!-- 1. Package Config -->
        <div class="bg-surface rounded-3xl border border-border/50 shadow-sm p-6 sm:p-8">
          <h2 class="text-2xl font-bold text-text mb-6">Configurar Pedido</h2>

          <div class="flex items-center justify-between p-4 bg-background/50 rounded-2xl border border-border">
            <div>
              <p class="text-sm font-medium text-text-light mb-1">Cantidad de paquetes</p>
              <p class="text-xs text-text-light/70">Multiplica tus beneficios</p>
            </div>

            <div class="flex items-center bg-surface border border-border rounded-xl shadow-sm">
              <button
                (click)="quantity = quantity > 1 ? quantity - 1 : 1"
                [disabled]="quantity <= 1"
                class="w-10 h-10 flex items-center justify-center text-text hover:bg-background rounded-l-xl transition-colors disabled:opacity-30 disabled:hover:bg-transparent">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
              </button>

              <input
                type="number"
                [(ngModel)]="quantity"
                min="1"
                class="w-12 text-center bg-transparent border-none font-bold text-text focus:ring-0 p-0"
              >

              <button
                (click)="quantity = quantity + 1"
                class="w-10 h-10 flex items-center justify-center text-text hover:bg-background rounded-r-xl transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- 2. Payment Methods -->
        <div class="bg-surface rounded-3xl border border-border/50 shadow-sm p-6 sm:p-8">
          <h2 class="text-2xl font-bold text-text mb-6">M√©todo de Pago</h2>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div *ngFor="let method of paymentMethods"
                 (click)="selectPaymentMethod(method.id)"
                 class="relative cursor-pointer group">

              <!-- Card visual -->
              <div class="p-4 rounded-2xl border-2 transition-all duration-300 flex items-center gap-4 h-full"
                   [ngClass]="{
                     'border-primary bg-primary/5 shadow-md': selectedPaymentMethodId === method.id,
                     'border-border hover:border-primary/30 hover:bg-background': selectedPaymentMethodId !== method.id
                   }">

                <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl bg-white shadow-sm"
                     [ngClass]="{'ring-2 ring-primary/20': selectedPaymentMethodId === method.id}">
                  {{ getPaymentMethodIcon(method.type) }}
                </div>

                <div class="flex-1">
                  <h4 class="font-bold text-text text-sm"
                      [ngClass]="{'text-primary': selectedPaymentMethodId === method.id}">
                    {{ method.name }}
                  </h4>

                  <!-- CORRECCI√ìN 1: Usamos $any() para evitar error 'Property description does not exist' -->
                  <p *ngIf="$any(method).description" class="text-xs text-text-light mt-0.5 line-clamp-1">
                    {{ $any(method).description }}
                  </p>
                </div>

                <!-- Check Circle -->
                <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors"
                     [ngClass]="{
                       'border-primary bg-primary text-white': selectedPaymentMethodId === method.id,
                       'border-border group-hover:border-primary/50': selectedPaymentMethodId !== method.id
                     }">
                  <svg *ngIf="selectedPaymentMethodId === method.id" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty State Payments -->
          <div *ngIf="paymentMethods.length === 0" class="text-center py-8 text-text-light">
            No hay m√©todos de pago disponibles.
          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN: Order Summary -->
      <div class="lg:col-span-5">
        <div class="sticky top-8">
          <div class="bg-surface rounded-3xl border border-border/50 shadow-xl overflow-hidden">

            <!-- Summary Header -->
            <div class="bg-gradient-to-r from-primary/10 to-primary/5 p-6 border-b border-border/50">
              <h3 class="font-bold text-text text-lg">Resumen del Pedido</h3>
            </div>

            <div class="p-6 space-y-6">
              <!-- Product Info -->
              <div class="flex gap-4">
                <div class="w-16 h-16 rounded-2xl bg-background border border-border flex items-center justify-center text-2xl shadow-sm">
                   üì¶
                </div>
                <div>
                  <h4 class="font-bold text-text text-lg">{{ pkg.name }}</h4>
                  <p class="text-sm text-text-light">{{ pkg.description }}</p>
                </div>
              </div>

              <hr class="border-dashed border-border">

              <!-- Calculations -->
              <div class="space-y-3 text-sm">
                <div class="flex justify-between text-text-light">
                  <span>Precio unitario</span>
                  <span>{{ pkg.price | currency:pkg.currency }}</span>
                </div>
                <div class="flex justify-between text-text-light">
                  <span>Cantidad</span>
                  <span>x {{ quantity }}</span>
                </div>
                <div class="flex justify-between font-medium text-text">
                  <span>Subtotal</span>
                  <!-- CORRECCI√ìN 2: Usamos $any() para evitar error de aritm√©tica -->
                  <span>{{ $any(pkg).price * quantity | currency:pkg.currency }}</span>
                </div>
              </div>

              <div class="bg-background rounded-xl p-4 border border-border">
                <div class="flex justify-between items-end">
                  <span class="font-bold text-text-light">Total a Pagar</span>
                  <span class="text-3xl font-black text-text tracking-tight">
                    <!-- CORRECCI√ìN 3: Usamos $any() aqu√≠ tambi√©n -->
                    {{ $any(pkg).price * quantity | currency:pkg.currency:'symbol':'1.0-0' }}
                  </span>
                </div>
              </div>

              <!-- Action Button -->
              <button
                (click)="confirmPurchase()"
                [disabled]="isProcessing || !selectedPaymentMethodId"
                class="w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all duration-300 flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed group relative overflow-hidden"
                [ngClass]="{
                  'bg-gradient-to-r from-primary to-primary-dark hover:shadow-primary/40 hover:-translate-y-0.5': !isProcessing,
                  'bg-gray-400 cursor-wait': isProcessing
                }">

                <!-- Loading Spinner -->
                <svg *ngIf="isProcessing" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>

                <span *ngIf="!isProcessing">Confirmar Compra</span>
                <span *ngIf="isProcessing">Procesando...</span>

                <!-- Shine Effect -->
                <div class="absolute top-0 -inset-full h-full w-1/2 z-5 block transform -skew-x-12 bg-gradient-to-r from-transparent to-white opacity-20 group-hover:animate-shine" *ngIf="!isProcessing"></div>
              </button>

              <p class="text-xs text-center text-text-light">
                Al confirmar, aceptas nuestros t√©rminos y condiciones de venta.
              </p>

            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
